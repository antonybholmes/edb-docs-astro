---
import DocPost from '@/components/help/DocPost.astro'
import { sortNode, type DocNode } from '@/lib/docs'
import { getCollection, type CollectionEntry } from 'astro:content'
import fs from 'fs'
import { globby } from 'globby'
import matter from 'gray-matter'

export async function getStaticPaths() {
  const DOCS_DIR = './src/content/docs'

  const files = await globby(`${DOCS_DIR}/**/*.md`)

  console.log(files)

  const rootNode: DocNode = {
    type: 'dir',
    title: '/',
    description: 'Documentation Root',
    weight: 0,
    slug: [],
    children: [],
  }

  let currentNode: DocNode = rootNode

  for (const file of files) {
    console.log('file', file)
    const path = file //.replace('.md', '')
    const slug = path.replace(DOCS_DIR + '/', '').split('/')

    const raw = fs.readFileSync(file, 'utf-8')

    const { data } = matter(raw)

    const subslugs = slug.map((_, i) => slug.slice(0, i + 1))

    currentNode = rootNode

    // build directories
    for (const subslug of subslugs) {
      const fullPath = DOCS_DIR + '/' + subslug.join('/')

      const stats = fs.statSync(fullPath)
      const isDirectory = stats.isDirectory()

      console.log('dirName', fullPath, 'isDirectory', isDirectory)

      if (isDirectory) {
        let dirName = fullPath.split('/').slice(-1)[0]
        let weight = Number.MAX_VALUE

        if (fs.existsSync(`${fullPath}/index.json`)) {
          const indexFile = fs.readFileSync(`${fullPath}/index.json`, 'utf-8')

          const indexData = JSON.parse(indexFile)

          console.log('indexData', path, indexData)

          dirName = indexData.title || dirName
          weight = indexData.index || weight
        }

        let nextNode: DocNode | undefined = currentNode.children.find(
          (c) => c.title === dirName
        )

        if (!nextNode) {
          nextNode = {
            type: 'dir',
            title: dirName,
            description: '',
            weight: weight,
            slug: subslug,
            children: [],
          }
          currentNode.children.push(nextNode)
        }

        currentNode = nextNode
      }
    }

    currentNode.children.push({
      type: 'article',
      title: data.title || slug[slug.length - 1],
      description: data.description || '',
      weight: data.weight || Number.MAX_VALUE,
      slug: slug.join('/').replace('.md', '').split('/'),
      children: [],
    })
  }

  const stack = [rootNode]

  while (stack.length > 0) {
    const node = stack.pop()!
    sortNode(node)
    stack.push(...node.children)
  }

  console.dir(rootNode, { depth: null })

  const posts = await getCollection('docs')
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post, rootNode },
  }))
}

type Props = { post: CollectionEntry<'docs'>; rootNode: DocNode }

const { slug } = Astro.params
const { post, rootNode } = Astro.props
---

<DocPost post={post} rootNode={rootNode} slug={slug.split('/')} />
